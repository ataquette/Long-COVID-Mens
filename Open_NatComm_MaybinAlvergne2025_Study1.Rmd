---
title: 'Long COVID and menstruation: potential bidirectional associations and mechanisms by Maybin et al. 2025'
author: "Alex Alvergne"
date: "2025-07-24"
output:
  html_document:
    df_print: paged
    toc: true
    theme: default

---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE, include=TRUE, 
                     warning=FALSE, message=FALSE, results="hide", 
                     verbose=FALSE)

# Suppress automatic headers that appear in TOC
options(pillar.print_max = 0)
options(tibble.print_max = 0)
options(dplyr.summarise.inform = FALSE)
options(tibble.width = Inf)
```

```{r packages}

# Ensures the package "pacman" is installed
if (!require("pacman")) install.packages("pacman")
# Packages available from CRAN
##############################

## Load
library(pacman)
pacman::p_load(
     rio,         # import/export
     here,        # file locator
     purrr,       # iteration
     gtsummary,
     tidyverse,
     flextable,
     ggplot2,
     forcats,
     kableExtra,
     flextable,
     Hmisc,
     pbapply,
     mice,
     GGally,
     effects,
     gridExtra,
     grid,
     lattice,
     gtsummary,
     dplyr,
     DiagrammeR,
     reporter# to do the flowchart
    
)

```

```{r dataload}
data<-import(here("Natcomm_Maybin2025.Rda")) # imputed list
```

# Descriptive Statistics

##### Table

```{r tabledesc, results='asis', echo=TRUE,include=TRUE}
# create tbl objects
theme_gtsummary_journal(journal = "jama")
theme_gtsummary_compact()
tbl <- 
  tbl_summary(
    select(data[[1]], age, bmi_group, contra_current_groupall, covid_tested, 
           vaccinated, vaccine_type, income_before, nbdeliveries, covid_group),  # Add covid_group here
    by = covid_group,
    label = list(
      age ~ "Age",
      bmi_group ~ "Body Mass Index",
      contra_current_groupall ~ "Contraceptive use at the time of the survey", 
      covid_tested ~ "COVID status (diagnosis)", 
      vaccinated ~ "Number of vaccination shots", 
      vaccine_type ~ "Vaccine type",
      income_before ~ "Income",
      nbdeliveries ~ "Number of deliveries"
      # Remove covid_group from labels since it's the grouping variable
    )
  )

# beautify
tblbest<-tbl %>%
  modify_caption("Table 1. Summary of the sample characteristics") %>%
  bold_labels()

# convert gtsummary object into flextable to export to word
tblbest%>%
  as_flex_table()%>%
  flextable::save_as_docx(path = "Table1.docx") 

# Display the table in markdown
tblbest
```

##### DAG

```{r dag_freq_normal, results='asis', echo=TRUE,include=TRUE,fig.show='true'}
p_load(dagitty)
p_load(ggdag)
p_load(ggplot2)


dagified <- dagify(cycle_lastyr ~ cyclechar_before_group + age + bmi + nbdeliveries + covid_group + contra +  disease_before_binary_num + stress,
                   cyclelength_before_group ~ age  + bmi  + disease_before_binary_num,
                   covid_group ~ age  + bmi +contra+disease_before_binary_num,
                   stress ~ covid_group,
                   nbdeliveries ~ age  ,
                   contra ~ age + bmi,
                   labels = c(
                   "cyclechar_before_group" = "cycle\n characteristics\n before\n the\n pandemic", 
                   "cycle_lastyr" = "cycle\n characteristics\n during\n the\n pandemic", 
                   "nbdeliveries" = "number\n of\n deliveries",
                   "disease_before_binary_num"= "disease\n before\n",
                   "age" = "age",
                   "bmi" = "BMI",
                   "contra" = "contraceptive\n use",
                   "covid_group" = "covid\n group",
                   "stress" = "pandemic\n stress"),
                   exposure = "covid_group",
                   outcome = "cycle_lastyr")%>% 
  tidy_dagitty()


  

# plot adjustment
pdf("Dag_adjusted.pdf")
ggdag_adjustment_set(dagified, stylized = FALSE,text_size = 3,node_size = 25,use_labels = "label", text = FALSE,shadow = TRUE) +
  theme_dag()
dev.off()

#
print(ggdag_adjustment_set(dagified, stylized = FALSE,text_size = 3,node_size = 25,use_labels = "label", text = FALSE,shadow = TRUE) +
  theme_dag())


```

##### Variant distribution: Supplemental File 1

```{r variant, results="asis", echo=TRUE}

# We compare the mean nb of days across the groups
datavariant<-data[[1]]
datavariant[datavariant$covid_group != "No COVID", ]

# Time to infection across groups and variants
# First, convert the factor to character
datavariant$covidsymptomstart_char <- as.character(datavariant$covidsymptomstart)
library(lubridate) # Parse dates 
datavariant$covidsymptomstart_date <- parse_date_time(datavariant$covidsymptomstart_char, "my")

# Calculate time to infection
datavariant$timetoinfection<-datavariant$start-datavariant$covidsymptomstart_date

# Difference between groups
tapply(datavariant$timetoinfection,datavariant$covid_group,mean,na.rm=T)
tapply(datavariant$timetoinfection,datavariant$covid_group,sd,na.rm=T)
datavariant$timetoinfection_num<-as.numeric(datavariant$timetoinfection)


##### Plot
# Create a subset excluding NA values
subset_data <- datavariant[!is.na(datavariant$variant) & 
                   datavariant$covid_group %in% c("Acute COVID", "Long COVID"), ]

# Density plots instead of histograms
ggplot(subset_data, aes(x = timetoinfection_num, fill = covid_group)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~ variant, scales = "free_y") +
  labs(title = "Time from COVID Symptom Onset to Survey Completion",
       subtitle = "By Variant and COVID Group",
       x = "Days between first COVID symptoms and survey completion", 
       y = "Density") +
  scale_fill_manual(values = c("Acute COVID" = "steelblue", "Long COVID" = "firebrick")) +
  theme_minimal() +
  theme(legend.position = "bottom")

# Export the plot (example with Option 2)
ggsave("covid_variant_group_histogram.png", width = 12, height = 8, dpi = 300)
ggsave("covid_variant_group_histogram.pdf", width = 12, height = 8, dpi = 300)




# Wilcox test
p_load("coin")
subset_data$covid_group<-droplevels(subset_data$covid_group)
datavariantnona<-subset_data %>% filter(!is.na(timetoinfection_num))
wilcox_test(datavariantnona$timetoinfection_num ~ datavariantnona$covid_group, distribution = "asymptotic")

# Chi-square test 
variant_table <- table(datavariantnona$covid_group, datavariantnona$variant)
chisq.test(variant_table)


# Get descriptive statistics for Wild Type variant
wild_type_data <- datavariantnona %>% filter(variant == "Wild Type")

# Summary statistics by group
wild_type_summary <- wild_type_data %>%
  group_by(covid_group) %>%
  summarise(
    n = n(),
    median = median(timetoinfection_num, na.rm = TRUE),
    mean = mean(timetoinfection_num, na.rm = TRUE),
    q25 = quantile(timetoinfection_num, 0.25, na.rm = TRUE),
    q75 = quantile(timetoinfection_num, 0.75, na.rm = TRUE),
    min = min(timetoinfection_num, na.rm = TRUE),
    max = max(timetoinfection_num, na.rm = TRUE),
    .groups = 'drop'
  )

wild_type_summary %>%
  knitr::kable(caption = "Summary statistics by COVID group",
               digits = 1)

# Also create a boxplot to visualize
library(ggplot2)
ggplot(wild_type_data, aes(x = covid_group, y = timetoinfection_num)) +
  geom_boxplot() +
  labs(title = "Time to infection by COVID group - Wild Type variant",
       y = "Time from infection to survey (days)",
       x = "COVID Group")


# Test for each variant separately
variants <- unique(datavariantnona$variant)

for(var in variants) {
  cat("Testing variant:", var, "\n")
  
  # Subset data for this variant
  subset_data <- datavariantnona %>% filter(variant == var)
  
  # Check sample sizes
  cat("Sample sizes:", table(subset_data$covid_group), "\n")
  
  # Run Wilcoxon test
  if(length(unique(subset_data$covid_group)) == 2) {
    result <- wilcox.test(timetoinfection_num ~ covid_group, data = subset_data)
    cat("p-value:", result$p.value, "\n")
    cat("W statistic:", result$statistic, "\n")
  } else {
    cat("Not enough groups to compare\n")
  }
  cat("-------------------\n")
}


```

# Frequency 

##### Multivariate

```{r logistic_freq_normal,  results='hide', echo=TRUE, message=FALSE}
# multinomial
p_load(nnet) # for multinomial model

# set global R options
pboptions(type = "timer", char = "=") # initialize progress bar

# set list of exposures to test
exposures <- c(
    Cs(
        covid_group  +cyclelength_before_group+contra_past12mo_groupall+disease_before_binary_num
        
        
    )
)


 # model function - multivariate
 models <- function(x) {
     lapply(data, function(y)
         multinom(as.formula(
             paste0(
                 "cyclelength_lastyr_group ~ age_scaled + bmi_group + ",
                 x # exposure
            )
         ), data = y, model = TRUE)
     )
 }

## run  models
models_univariate <- as.list(seq(1,length(exposures))) # create list to store model results
models_univariate <- pblapply(exposures, models)





### Pool -------------------------------------------------------------------

pool_univariate <- as.list(seq(1,length(exposures))) # create list to store pool results

# run pool
for(j in seq_along(exposures)) {
    pool_univariate[[j]] <- pool(models_univariate[[j]])
}



### Get the table ------------------------------------------------------

#### create report for model with age, bmi and contraceptive use
tab<-summary(pool_univariate[[1]])
##



# this is the FDR p values
tab$q.value <- p.adjust(tab$p.value,method = "BH")


#
tab2 <- tab %>% mutate(RRR = round (exp(estimate),2),
                      LowCI = round(exp (estimate - 1.96*std.error),2),
                      HighCI = round(exp (estimate + 1.96*std.error),2),
                      p.value = round ((p.value),4),
                      q.value = round ((q.value),4))%>%
                select(y.level ,term,RRR,LowCI,HighCI, p.value,q.value)



library(reporter)

tbl <- create_table(tab2) %>% 
  titles("Pooled Multivariate Models (Cycle Frequency) _LONGCOVID")
rpt <- create_report("Multi_full_Frequency_LONGCOVID.pdf", font_size=  8, output_type = "PDF") %>% 
  add_content(tbl)
write_report(rpt)


```



```{r tbl1,results="asis", include=TRUE}
knitr::kable(tab2, caption = "Summary Table")
```

##### Plot

```{r plot_freq_normal, include=FALSE}

#----------------------- plot predicted effect sizes


mod1<-multinom(cyclelength_lastyr_group ~ covid_group + cyclelength_before_group+age_group+ bmi_group +contra_past12mo_groupall+disease_before_binary_num, data=data[[1]])


# Plot combined#
# Save results
library(ggeffects)
library(ggsignif)
pprob_grplang <- ggeffect(mod1, terms = "covid_group",back.transform = TRUE)

# Plot summary model
ggcoef_multinom(mod1,
                type = "faceted",
                exponentiate = TRUE)

# Table
mod1 %>%
  tbl_regression(exponentiate = TRUE) %>%
  add_global_p(type = "II")



# Build plot
plot_freq_figo1_comb<-ggplot(data = pprob_grplang,
       aes(x = x, y = predicted,
           color = response.level, group = response.level)) +
  #geom_line() +
  geom_point() +
  ggtitle("Cycle frequency")+
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high,
                    color = response.level,
                    group = response.level),
                width = .1) +
  scale_color_brewer(palette = "Dark2",
                     name = "",
                     labels = c("Frequent",
                                "Infrequent",
                                "Normal")) +
  labs(
    x = "",
    y = "Predicted probability"
  ) +
  # Set the theme
  theme_minimal() +
  theme(
    legend.position = "bottom", # move legend to the bottom
    axis.title = element_text(size = 8),
        legend.text = element_text(size = 8),
# increase axis title size
  )

ggsave("plot_frequency_predicted_LONGCOVID.bmp",plot_freq_figo1_comb, width=5, height=5)

#
```

```{r plot1, results="asis", fig.width = 10, message=FALSE}
plot_freq_figo1_comb
```

# Missed or stopped

#### Multivariate

```{r cyclefrequency, results='hide', echo=TRUE, message=FALSE}
# glm
p_load(nnet) # for multinomial model

# set global R options
pboptions(type = "timer", char = "=") # initialize progress bar

# set list of exposures to test
exposures <- c(
    Cs(
  covid_group  +contra_past12mo_groupall+disease_before_binary_num
    )
)


 #model function - multivariate
models <- function(x) {
    lapply(data, function(y)
        glm(as.formula(
            paste0(
                "stoppedperiods_lastyr ~ age_scaled + bmi_group + ",
                x
                
            )
        ), data = y, model=TRUE, family=binomial(link="log"))
    )
}


## run  models
models_univariate <- as.list(seq(1,length(exposures))) # create list to store model results
models_univariate <- pblapply(exposures, models)



### Pool -------------------------------------------------------------------

pool_univariate <- as.list(seq(1,length(exposures))) # create list to store pool results

# run pool
for(j in seq_along(exposures)) {
    pool_univariate[[j]] <- pool(models_univariate[[j]])
}


#### create report for cycle length before + contra + age + bmi + covidstatus
tab<-summary(pool_univariate[[1]])

tab$q.value <- p.adjust(tab$p.value,method = "BH")

tab2 <- tab %>% mutate(PR = round (exp(estimate),2),
                      LowCI = round(exp (estimate - 1.96*std.error),2),
                      HighCI = round(exp (estimate + 1.96*std.error),2),
                      p.value = round ((p.value),4),
                      q.value = round ((q.value),4))%>%
                select(term,PR,LowCI,HighCI, p.value, q.value)



library(reporter)

tbl <- create_table(tab2) %>% 
  titles("Pooled Multivariate Models (Periods Stopped)_LONGCOVID")
rpt <- create_report("Multi_full_Frequency_Stopped_LONGCOVID.pdf", font_size=  8, output_type = "PDF") %>% 
  add_content(tbl)
write_report(rpt)


```

```{r tbl2,results="asis", include=TRUE}
knitr::kable(tab2, caption = "Summary Table")

```


#### Plot

```{r plot_miss,  include=FALSE}

m<-glm(stoppedperiods_lastyr ~ age_group + bmi_group +cyclelength_before_group+ covid_group+disease_before_binary_num+contra_past12mo_groupall  , data=data[[1]], family=binomial(link="log"))

# Save results
pprob_grplang <- ggeffect(m, terms = "covid_group")


# Build plot
plot_miss_figo_covax_comb<-ggplot(data = pprob_grplang,
       aes(x = x, y = predicted)) +
 # geom_line() +
  geom_point() +
  ggtitle("Period reported missed")+
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high),
                width = .1) +
  scale_color_brewer(palette = "Dark2") +
  labs(
    x = "",
    y = "Predicted probability"
  ) +
  # Set the theme
  theme_minimal() +
  theme(
    legend.position = "bottom", # move legend to the bottom
    axis.title = element_text(size = 8),
    legend.text = element_text(size = 8)
# increase axis title size
  )

ggsave("plot_frequency_stop_predictedLongCOVID.bmp",plot_miss_figo_covax_comb, width=5, height=5)

```


```{r plot2, results="asis", fig.width = 10, message=FALSE}
plot_miss_figo_covax_comb
```

# Cycle Regularity {.tabset .tabset-fade .tabset-pills}

#### Model multivariate

```{r cyclereg, results='hide', echo=TRUE, message=FALSE}

# multinomial
p_load(nnet) # for multinomial model

# set global R options
pboptions(type = "timer", char = "=") # initialize progress bar

# set list of exposures to test
exposures <- c(
    Cs(
       covid_group  +cycle_irreg_before_group+contra_past12mo_groupall+disease_before_binary_num
    )
)



 #model function - multivariate
 models <- function(x) {
     lapply(data, function(y)
         multinom(as.formula(
             paste0(
                 "cyclelength_irregular_lastyr_group ~ age_scaled + bmi_group + ",
                 x # exposure
            )
         ), data = y, model=TRUE)
     )
 }

## run  models
models_univariate <- as.list(seq(1,length(exposures))) # create list to store model results
models_univariate <- pblapply(exposures, models)


### Pool -------------------------------------------------------------------

pool_univariate <- as.list(seq(1,length(exposures))) # create list to store pool results

# run pool
for(j in seq_along(exposures)) {
    pool_univariate[[j]] <- pool(models_univariate[[j]])
}


# Table
tab<-summary(pool_univariate[[1]])# put in model you want to see

tab$q.value <- p.adjust(tab$p.value,method = "BH")


tab2 <- tab %>% mutate(RRR = round (exp(estimate),2),
                      LowCI = round(exp (estimate - 1.96*std.error),2),
                      HighCI = round(exp (estimate + 1.96*std.error),2),
                      p.value = round ((p.value),4),
                      q.value= round ((q.value),4))%>%
                select(y.level ,term,RRR,LowCI,HighCI, p.value,q.value)


library(reporter)

tbl <- create_table(tab2) %>% 
  titles("Pooled Multivariate Models (Cycle Regularity)_LONGCOVID ")
rpt <- create_report("Multi_full_Regularity_LONGCOVID.pdf", font_size=  8, output_type = "PDF") %>% 
  add_content(tbl)
write_report(rpt)


```


```{r tbl3,results="asis", include=TRUE}
knitr::kable(tab2, caption = "Summary Table")

```


#### Plot

```{r plot_cyclechanges, include=FALSE}

m<-multinom(cyclelength_irregular_lastyr_group  ~  age_group +covid_group+cycle_irreg_before_group+ bmi_group +disease_before_binary_num +contra_past12mo_groupall , data=data[[3]])

# Plot combined

# Save results
pprob_grplang <- ggeffect(m, terms = "covid_group")

##
# Plot summary model
#library(sjPlot)
#forest_reg<-plot_model(m, type=c("est"),show.values = TRUE, title="Cycle regularity During the Pandemic", colors="Set1",value.offset = 0.4, line.size = 1)+theme_minimal()
#ggsave("forest_reg_predicted_LONGCOVID.bmp",forest_reg, width=10, height=7)


# Build plot
plot_reg_figo1_comb<-ggplot(data = pprob_grplang,
       aes(x = x, y = predicted,
           color = response.level, group = response.level)) +
  #geom_line() +
  geom_point() +
  ggtitle("Cycle regularity")+
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high,
                    color = response.level,
                    group = response.level),
                width = .1) +
  scale_color_brewer(palette = "Dark2",
                     name = "",
                     labels = c("Irregular",
                                "Very Irregular",
                                "Regular")) +
  labs(
    x = "",
    y = "Predicted probability"
  ) +
  # Set the theme
  theme_minimal() +
  theme(
    legend.position = "bottom", # move legend to the bottom
    axis.title = element_text(size = 8),
            legend.text = element_text(size = 8)
# increase axis title size
  )

ggsave("plot_regularity_predicted_LONGCOVID.bmp",plot_reg_figo1_comb, width=5, height=5)

```


```{r plot3, results="asis", fig.width = 10, message=FALSE}
plot_reg_figo1_comb
```


# Period Duration 

#### Model multivariate


```{r period_duration,results='hide', echo=TRUE, message=FALSE}

# set global R options
pboptions(type = "timer", char = "=") # initialize progress bar

# set list of exposures to test
exposures <- c(
    Cs(
         covid_group  +period_lengh_before_group+contra_past12mo_groupall+disease_before_binary_num
   
    )
)


 #model function - multivariate
 models <- function(x) {
     lapply(data, function(y)
         glm(as.formula(
             paste0(
                 "period_lengh_lastyr_group ~ age_scaled + bmi_group  + ",
                 x # exposure
            )
         ), data = y, family=binomial())
     )
 }

## run  models
models_univariate <- as.list(seq(1,length(exposures))) # create list to store model results
models_univariate <- pblapply(exposures, models)







### Pool -------------------------------------------------------------------

pool_univariate <- as.list(seq(1,length(exposures))) # create list to store pool results

# run pool
for(j in seq_along(exposures)) {
    pool_univariate[[j]] <- pool(models_univariate[[j]])
}



# all models together


# Table
tab<-summary(pool_univariate[[1]])

tab$q.value <- p.adjust(tab$p.value,method = "BH")


tab2 <- tab %>% mutate(PR = round (exp(estimate),2),
                      LowCI = round(exp (estimate - 1.96*std.error),2),
                      HighCI = round(exp (estimate + 1.96*std.error),2),
                      p.value = round ((p.value),4),
                      q.value = round ((q.value),4))%>%
                select(term,PR,LowCI,HighCI, p.value, q.value)


library(reporter)

tbl <- create_table(tab2) %>% 
  titles("Pooled Multivariate Models (Period Duration) LONG COVID ")
rpt <- create_report("Multi_full_Duration_LONGCOVID.pdf", font_size=  8, output_type = "PDF") %>% 
  add_content(tbl)
write_report(rpt)



```

```{r tbl4,results="asis", include=TRUE}
knitr::kable(tab2, caption = "Summary Table")

```


#### Plot

```{r plot_p_duration,  include=FALSE}

m<-glm(period_lengh_lastyr_group ~ age_group+bmi_group  + covid_group+period_lengh_before_group +disease_before_binary_num+contra_past12mo_groupall, data=data[[1]], family=binomial)


# plot combined
# Save results
pprob_grplang <- ggeffect(m, terms = "covid_group")

# Build plot
plot_dur_figo_covax_comb<-ggplot(data = pprob_grplang,
       aes(x = x, y = predicted)) +
#  geom_line() +
  geom_point() +
  ggtitle("Period duration (8+ days)")+
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high),
                width = .1) +
  scale_color_brewer(palette = "Dark2") +
  labs(
    x = "",
    y = "Predicted probability"
  ) +
  # Set the theme
  theme_minimal() +
  theme(
    legend.position = "bottom", # move legend to the bottom
    axis.title = element_text(size = 8),
            legend.text = element_text(size = 8)
# increase axis title size
  )

ggsave("plot_dur_predicted_LONGCOVID.bmp",plot_dur_figo_covax_comb, width=5, height=5)


```



```{r plot4, results="asis", fig.width = 10, message=FALSE}
plot_dur_figo_covax_comb
```


# Period Flow 

#### Multivariate

```{r logistic_multi_periods,rresults='hide', echo=TRUE, message=FALSE}
# multinomial
p_load(nnet) # for multinomial model

# set global R options
pboptions(type = "timer", char = "=") # initialize progress bar

# set list of exposures to test
exposures <- c(
    Cs(
   
    covid_group  +heavyperiod_before+contra_past12mo_groupall+disease_before_binary_num
   
        
    )
)


 #model function - multivariate
 models <- function(x) {
     lapply(data, function(y)
         multinom(as.formula(
             paste0(
                 "changesperiod_lastyr ~ age_scaled + bmi_group  +",
                 x # exposure
            )
         ), data = y, model = TRUE)
     )
 }

## run  models
models_univariate <- as.list(seq(1,length(exposures))) # create list to store model results
models_univariate <- pblapply(exposures, models)







### Pool -------------------------------------------------------------------

pool_univariate <- as.list(seq(1,length(exposures))) # create list to store pool results

# run pool
for(j in seq_along(exposures)) {
    pool_univariate[[j]] <- pool(models_univariate[[j]])
}


```

#### Table multivariate

```{r table_multi_periodchanges}

# Table
tab<-summary(pool_univariate[[1]])

tab$q.value <- p.adjust(tab$p.value,method = "BH")

tab2 <- tab %>% mutate(RRR = round (exp(estimate),2),
                      LowCI = round(exp (estimate - 1.96*std.error),2),
                      HighCI = round(exp (estimate + 1.96*std.error),2),
                      p.value = round ((p.value),4),
                     p.value = round ((q.value),4)) %>%
                select(y.level ,term,RRR,LowCI,HighCI, p.value,q.value)


library(reporter)

tbl <- create_table(tab2) %>% 
  titles("Pooled Multivariate Models (Period Flow) Long COVID")
rpt <- create_report("Multi_fullFlow_LONGCOVID.pdf", font_size=  8, output_type = "PDF") %>% 
  add_content(tbl)
write_report(rpt)


```

```{r tbl5,results="asis", include=TRUE}
knitr::kable(tab2, caption = "Summary Table")

```



#### Plot

```{r plot_periodchanges,  include=FALSE}

## plot
levels(data[[1]]$changesperiod_lastyr)[4]<-"Lighter and Heavier"

m<-multinom(changesperiod_lastyr  ~  age_scaled +covid_group+ bmi_group +disease_before_binary_num  , data=data[[1]])



# Save results
pprob_grplang <- ggeffect(m, terms = "covid_group")

# Build plot
plot_flow_figo_cov_comb<-ggplot(data = pprob_grplang,
       aes(x = x, y = predicted,
           color = response.level, group = response.level)) +
  #geom_line() +
  geom_point() +
  ggtitle("Period flow")+
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high,
                    color = response.level,
                    group = response.level),
                width = .1) +
  scale_color_brewer(palette = "Dark2",
                     name = "",
                     labels = c("Heavier",
                                "Lighter",
                                "Both",
                                "No changes")) +
  labs(
    x = "",
    y = "Predicted probability"
  ) +
  # Set the theme
  theme_minimal() +
  theme(
    legend.position = "bottom", # move legend to the bottom
    axis.title = element_text(size = 8),
            legend.text = element_text(size = 8)
# increase axis title size
  )

ggsave("plot_flow_predicted_LONGCOVID.bmp",plot_flow_figo_cov_comb, width=5, height=5)



```



```{r plot5, results="asis", fig.width = 10, message=FALSE}
plot_flow_figo_cov_comb
```



# Interperiod bleeding

##### Multivariate

```{r logistic_IMB_normal ,  results='hide', echo=TRUE, message=FALSE}
for(i in 1:5) {
  data[[i]]$changesspotting_lastyr <- relevel(data[[i]]$changesspotting_lastyr, ref = "No changes")
}

# multinomial
p_load(nnet) # for multinomial model

# set global R options
pboptions(type = "timer", char = "=") # initialize progress bar

# set list of exposures to test
exposures <- c(
    Cs(
        covid_group  +cyclelength_before_group+contra_past12mo_groupall+disease_before_binary_num))



 #model function - multivariate
 models <- function(x) {
     lapply(data, function(y)
         multinom(as.formula(
             paste0(
                 "changesspotting_lastyr ~ age_scaled + bmi_group + ",
                 x # exposure
            )
         ), data = y, model = TRUE)
     )
 }

## run  models
models_univariate <- as.list(seq(1,length(exposures))) # create list to store model results
models_univariate <- pblapply(exposures, models)





### Pool -------------------------------------------------------------------

pool_univariate <- as.list(seq(1,length(exposures))) # create list to store pool results

# run pool
for(j in seq_along(exposures)) {
    pool_univariate[[j]] <- pool(models_univariate[[j]])
}


#summary(D2(models_univariate[[1]], models_univariate[[2]]))


### Get the table ------------------------------------------------------

#### create report for model with age, bmi and contraceptive use
tab<-summary(pool_univariate[[1]])

tab$q.value <- p.adjust(tab$p.value,method = "BH")


tab2 <- tab %>% mutate(RRR = round (exp(estimate),2),
                      LowCI = round(exp (estimate - 1.96*std.error),2),
                      HighCI = round(exp (estimate + 1.96*std.error),2),
                      p.value = round ((p.value),4),
                      q.value = round ((q.value),4))%>%
                select(y.level ,term,RRR,LowCI,HighCI, p.value, q.value)



library(reporter)

tbl <- create_table(tab2) %>% 
  titles("Pooled Multivariate Models (Inter-Menstrual Bleeding) ")
rpt <- create_report("Multi_full_Spotting_LONGCOVID.pdf", font_size=  8, output_type = "PDF") %>% 
  add_content(tbl)
write_report(rpt)



##-------------------------------------------------------AIC models from 1st
library(modelsummary)
library(kableExtra)
library(gt)

```

```{r tbl6,results="asis", include=TRUE}
knitr::kable(tab2, caption = "Summary Table")

```


##### Plot

```{r plot_IMB_normal, include=FALSE}

#------------------------------------------------------ plot predicted effect sizes

mod1<-multinom(changesspotting_lastyr ~ cyclelength_before_group +covid_group + age_group+ bmi_group +contra_past12mo_groupall+disease_before_binary_num, data=data[[1]])


# Save results
pprob_grplang <- ggeffect(mod1, terms = "covid_group")



# Build plot
plot_IMB_figo1_com<-ggplot(data = pprob_grplang,
       aes(x = x, y = predicted,
           color = response.level, group = response.level)) +
#  geom_line() +
  geom_point() +
  ggtitle("Inter-menstrual bleeding")+
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high,
                    color = response.level,
                    group = response.level),
                width = .1) +
  scale_color_brewer(palette = "Dark2",
                     name = "",
                     labels = c("Less",
                                "More",
                                "No changes",
                                "Both")) +
  labs(
    x = "",
    y = "Predicted probability"
  ) +
  # Set the theme
  theme_minimal() +
  theme(
    legend.position = "bottom", # move legend to the bottom
    axis.title = element_text(size = 8),
            legend.text = element_text(size = 8)
# increase axis title size
  )

ggsave("plot_IMB_predicted_LONGCOVID.bmp",plot_IMB_figo1_com, width=5, height=5)

```


```{r plot6, results="asis", fig.width = 10, message=FALSE}
plot_IMB_figo1_com
```




# General Plot

```{r plot_all, results="asis", fig.width=14}


 ## Plot covid predictd probabilities
p_load(ggpubr)


 
all<-ggarrange(
  plot_freq_figo1_comb,
  plot_reg_figo1_comb,
  plot_flow_figo_cov_comb,
  plot_dur_figo_covax_comb,
  plot_IMB_figo1_com,
  plot_miss_figo_covax_comb,
  labels = c("A", "B","C","D","E","F"),
  widths=c(5,5),
  heights=c(5,5,5),
  ncol=2,
  nrow=3)

 
print(all)

ggsave("Figure1.bmp",all, width=12, height=14)
ggsave("Figure1.pdf",all, width=12, height=14)
ggsave("Figure1.jpeg",all, width=12, height=14)
ggsave("Figure1.png",all, width=7, height=8)

 
```
